<!DOCTYPE html>
<html>
<head>
    <title>G√©olocalisation WiFi - Esclangon</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet.js : Biblioth√®que de cartographie interactive open-source -->
    <!-- Utilis√©e pour afficher la carte OpenStreetMap et les marqueurs de position -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* ================================================================
           STYLES G√âN√âRAUX
           ================================================================ */
        
        /* Reset CSS : supprime les marges/paddings par d√©faut du navigateur */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Corps de la page : fond sombre, police syst√®me moderne */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;     /* Bleu tr√®s fonc√© */
            color: #e0e0e0;          /* Gris clair pour le texte */
        }
        
        /* ================================================================
           LAYOUT PRINCIPAL
           ================================================================ */
        
        /* Container : layout flexbox horizontal (sidebar + carte) */
        .container {
            display: flex;
            height: 100vh;          /* Hauteur plein √©cran */
        }
        
        /* Sidebar gauche : affiche les informations de localisation */
        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, #1a1f3a 0%, #0f1729 100%);
            padding: 25px;
            overflow-y: auto;       /* Scroll si contenu trop long */
            box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        }
        
        /* ================================================================
           HEADER (Titre + Sous-titre)
           ================================================================ */
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2a3f5f;
        }
        
        .header h1 {
            font-size: 24px;
            color: #64b5f6;         /* Bleu clair */
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 12px;
            color: #7e8ba3;         /* Gris bleut√© */
        }
        
        /* ================================================================
           INDICATEUR DE STATUT (Connect√© / D√©connect√©)
           ================================================================ */
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);    /* Vert semi-transparent */
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        /* Point lumineux anim√© indiquant le statut de connexion */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;     /* Forme circulaire */
            background: #4CAF50;    /* Vert = connect√© */
            margin-right: 10px;
            animation: pulse 2s infinite;  /* Animation pulsation */
        }
        
        /* Point rouge quand d√©connect√© */
        .status-dot.disconnected {
            background: #f44336;    /* Rouge */
        }
        
        /* Animation de pulsation (breathing effect) */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* ================================================================
           CARTES D'INFORMATION (Salle, √âtage, Position, etc.)
           ================================================================ */
        
        /* Carte avec effet de profondeur et hover */
        .info-card {
            background: linear-gradient(135deg, #1e2842 0%, #252d47 100%);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #2a3f5f;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;  /* Animation hover */
        }
        
        /* Effet de survol : la carte se soul√®ve l√©g√®rement */
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        /* Label d'une information (ex: "SALLE D√âTECT√âE") */
        .info-label {
            font-size: 11px;
            color: #7e8ba3;
            text-transform: uppercase;
            letter-spacing: 1px;    /* Espacement des lettres */
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        /* Valeur principale d'une information (ex: "201") */
        .info-value {
            font-size: 28px;
            font-weight: 700;
            color: #64b5f6;         /* Bleu clair */
            text-shadow: 0 2px 4px rgba(100, 181, 246, 0.3);  /* Ombre lumineuse */
        }
        
        /* Variante plus petite pour les textes longs */
        .info-value.large {
            font-size: 20px;
        }
        
        /* Badge indiquant la m√©thode de localisation (ex: "RSSI Matching") */
        .method-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(100, 181, 246, 0.2);
            border-radius: 12px;
            font-size: 11px;
            color: #64b5f6;
            margin-top: 5px;
        }
        
        /* ================================================================
           SECTION D√âTAILS DES APs
           ================================================================ */
        
        /* Container de la liste des APs d√©tect√©s */
        .details-section {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* Titre de la section */
        .details-title {
            font-size: 13px;
            color: #7e8ba3;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* Item repr√©sentant un AP (adresse MAC + RSSI) */
        .ap-item {
            display: flex;
            justify-content: space-between;  /* MAC √† gauche, RSSI √† droite */
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 12px;
        }
        
        /* Pas de bordure pour le dernier item */
        .ap-item:last-child {
            border-bottom: none;
        }
        
        /* Adresse MAC affich√©e en police monospace */
        .ap-mac {
            color: #90caf9;         /* Bleu clair */
            font-family: 'Courier New', monospace;
        }
        
        /* Valeur RSSI en vert */
        .ap-rssi {
            color: #a5d6a7;         /* Vert pastel */
            font-weight: 600;
        }
        
        /* ================================================================
           CARTE LEAFLET
           ================================================================ */
        
        /* Container de la carte : prend tout l'espace restant */
        #map {
            flex: 1;
            position: relative;
        }
        
        /* ================================================================
           COULEURS DE CONFIANCE
           ================================================================ */
        
        /* Confiance √©lev√©e (>= 70%) : vert */
        .confidence-high {
            color: #4CAF50;
        }
        
        /* Confiance moyenne (40-70%) : orange */
        .confidence-medium {
            color: #FF9800;
        }
        
        /* Confiance faible (< 40%) : rouge */
        .confidence-low {
            color: #f44336;
        }
        
        /* ================================================================
           GRILLE DE STATISTIQUES
           ================================================================ */
        
        /* Grid 2 colonnes pour afficher APs d√©tect√©s / APs en base */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Box individuelle de statistique */
        .stat-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        /* Valeur de la statistique (nombre) */
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #64b5f6;
        }
        
        /* Label de la statistique */
        .stat-label {
            font-size: 10px;
            color: #7e8ba3;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- ================================================================
         STRUCTURE HTML : SIDEBAR + CARTE
         ================================================================ -->
    
    <div class="container">
        <!-- SIDEBAR GAUCHE : Dashboard d'informations -->
        <div class="sidebar">
            <!-- Header avec titre et sous-titre -->
            <div class="header">
                <h1>üìç WiFi Localisation</h1>
                <div class="subtitle">Polytech Sorbonne - B√¢timent Esclangon</div>
            </div>
            
            <!-- Indicateur de connexion WebSocket -->
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connexion...</span>
            </div>
            
            <!-- Carte 1 : Salle d√©tect√©e -->
            <div class="info-card">
                <div class="info-label">üö™ SALLE D√âTECT√âE</div>
                <div class="info-value" id="room">---</div>
                <div class="method-badge" id="method">En attente</div>
            </div>
            
            <!-- Carte 2 : √âtage -->
            <div class="info-card">
                <div class="info-label">üè¢ √âTAGE</div>
                <div class="info-value" id="floor">---</div>
            </div>
            
            <!-- Carte 3 : Position / Description -->
            <div class="info-card">
                <div class="info-label">üìç POSITION</div>
                <div class="info-value large" id="location">En attente de donn√©es...</div>
            </div>
            
            <!-- Carte 4 : Confiance + Statistiques -->
            <div class="info-card">
                <div class="info-label">üéØ CONFIANCE</div>
                <div class="info-value" id="confidence">---</div>
                
                <!-- Grid de statistiques -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="matchedAPs">0</div>
                        <div class="stat-label">APs D√©tect√©s</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalAPs">0</div>
                        <div class="stat-label">APs en Base</div>
                    </div>
                </div>
            </div>
            
            <!-- Carte 5 : Derni√®re mise √† jour -->
            <div class="info-card">
                <div class="info-label">üïê DERNI√àRE MAJ</div>
                <div class="info-value large" id="time">---</div>
            </div>
            
            <!-- Section d√©tails : Liste des APs d√©tect√©s -->
            <div class="details-section">
                <div class="details-title">üì° Points d'acc√®s d√©tect√©s</div>
                <div id="details"></div>
            </div>
        </div>
        
        <!-- CARTE DROITE : Carte interactive Leaflet -->
        <div id="map"></div>
    </div>

    <script>
        /* ================================================================
           INITIALISATION DE LA CARTE LEAFLET
           ================================================================
           
           Leaflet.js est une biblioth√®que JavaScript pour cartes interactives.
           Plus l√©g√®re et simple que Google Maps API.
        */
        
        // Cr√©er la carte centr√©e sur Polytech Sorbonne (Esclangon)
        // Coordonn√©es: 48.845151, 2.357054
        // Zoom: 19 (tr√®s proche, niveau b√¢timent)
        const map = L.map('map').setView([48.845151, 2.357054], 19);
        
        // Ajouter la couche de tuiles OpenStreetMap
        // OpenStreetMap est une carte collaborative libre et gratuite
        // Alternatives: Google Maps, Mapbox, etc.
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 20     // Zoom maximum autoris√©
        }).addTo(map);
        
        /* ================================================================
           VARIABLES GLOBALES
           ================================================================ */
        
        let marker = null;              // Marqueur rouge de position actuelle
        let apMarkers = [];             // Array des marqueurs bleus des APs connus
        let statusConnected = false;    // √âtat de connexion WebSocket
        
        /* ================================================================
           WEBSOCKET : COMMUNICATION TEMPS R√âEL AVEC LE BACKEND
           ================================================================
           
           WebSocket permet une communication bidirectionnelle en temps r√©el.
           Avantages vs HTTP polling:
           - Latence ultra-faible (~10ms vs 1000ms)
           - Pas de surcharge r√©seau (1 connexion vs requ√™te/seconde)
           - Push du serveur vers client (pas besoin de demander)
        */
        
        // Se connecter au serveur WebSocket sur localhost:8000
        const ws = new WebSocket('ws://localhost:8000/ws');
        
        /* ================================================================
           FONCTION : MISE √Ä JOUR DU STATUT DE CONNEXION
           ================================================================ */
        
        function updateStatus(connected) {
            /*
             * Met √† jour l'indicateur de statut en haut du dashboard.
             * 
             * Param√®tres:
             *   connected (bool): true si WebSocket connect√©, false sinon
             * 
             * Actions:
             *   - Change la couleur du point (vert/rouge)
             *   - Change le texte du statut
             */
            statusConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                // √âtat connect√©
                dot.classList.remove('disconnected');
                text.textContent = 'Connect√© ‚Ä¢ Temps r√©el';
                text.style.color = '#4CAF50';
            } else {
                // √âtat d√©connect√©
                dot.classList.add('disconnected');
                text.textContent = 'D√©connect√©';
                text.style.color = '#f44336';
            }
        }
        
        /* ================================================================
           FONCTION : CLASSE CSS SELON CONFIANCE
           ================================================================ */
        
        function getConfidenceClass(confidenceStr) {
            /*
             * Retourne la classe CSS appropri√©e selon le niveau de confiance.
             * 
             * Param√®tres:
             *   confidenceStr (string): Confiance en % (ex: "97%")
             * 
             * Retourne:
             *   string: Nom de classe CSS ('confidence-high', 'medium', ou 'low')
             * 
             * Seuils:
             *   >= 70% ‚Üí Vert (haute confiance)
             *   40-69% ‚Üí Orange (confiance moyenne)
             *   < 40%  ‚Üí Rouge (faible confiance)
             */
            const value = parseInt(confidenceStr);
            if (value >= 70) return 'confidence-high';
            if (value >= 40) return 'confidence-medium';
            return 'confidence-low';
        }
        
        /* ================================================================
           WEBSOCKET : R√âCEPTION DES DONN√âES EN TEMPS R√âEL
           ================================================================
           
           Callback d√©clench√© quand le backend envoie une nouvelle position.
           
           Flow:
           1. ESP32 d√©tecte des APs WiFi
           2. Backend calcule la position (RSSI Matching)
           3. Backend envoie via WebSocket ‚Üí ce callback se d√©clenche
           4. Frontend met √† jour instantan√©ment la carte et le dashboard
        */
        
        ws.onmessage = (event) => {
            /*
             * Traite les messages WebSocket re√ßus du backend.
             * 
             * Format du message (JSON):
             * {
             *     "success": true,
             *     "lat": 48.845129,
             *     "lon": 2.356774,
             *     "room": "201",
             *     "floor": "2",
             *     "location": "Salle 201",
             *     "method": "RSSI Matching",
             *     "confidence": "97%",
             *     "matched_aps": 3,
             *     "details": [
             *         {"mac": "1e:92:9b:e8:5c:d9", "rssi": -65},
             *         {"mac": "76:a0:74:60:bb:9d", "rssi": -70}
             *     ],
             *     "timestamp": "2025-01-20T17:30:00"
             * }
             */
            
            // Parser le JSON
            const data = JSON.parse(event.data);
            
            // V√©rifier que la localisation a r√©ussi
            if (data.success) {
                // ============================================================
                // MISE √Ä JOUR DU MARQUEUR SUR LA CARTE
                // ============================================================
                
                if (marker) {
                    // Si marqueur existe d√©j√†, simplement d√©placer
                    marker.setLatLng([data.lat, data.lon]);
                } else {
                    // Sinon, cr√©er un nouveau marqueur rouge
                    marker = L.marker([data.lat, data.lon], {
                        icon: L.icon({
                            // Utiliser un marqueur rouge depuis GitHub
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map)
                      .bindPopup(`<b>${data.room}</b><br>√âtage ${data.floor}<br>${data.location}`);
                }
                
                // Centrer la carte sur la nouvelle position
                map.setView([data.lat, data.lon], 19);
                
                // ============================================================
                // MISE √Ä JOUR DU DASHBOARD
                // ============================================================
                
                // Salle d√©tect√©e
                document.getElementById('room').textContent = data.room;
                
                // √âtage
                document.getElementById('floor').textContent = data.floor;
                
                // Description de la position
                document.getElementById('location').textContent = data.location;
                
                // M√©thode de localisation utilis√©e
                document.getElementById('method').textContent = data.method || 'Unknown';
                
                // Confiance avec couleur dynamique
                const confidenceEl = document.getElementById('confidence');
                confidenceEl.textContent = data.confidence;
                confidenceEl.className = 'info-value ' + getConfidenceClass(data.confidence);
                
                // Nombre d'APs match√©s
                document.getElementById('matchedAPs').textContent = data.matched_aps || 0;
                
                // Heure de mise √† jour
                const timestamp = new Date(data.timestamp);
                document.getElementById('time').textContent = timestamp.toLocaleTimeString('fr-FR');
                
                // ============================================================
                // LISTE DES APs D√âTECT√âS
                // ============================================================
                
                let detailsHTML = '';
                if (data.details && data.details.length > 0) {
                    // Construire le HTML pour chaque AP
                    data.details.forEach(ap => {
                        const ssid = ap.ssid || 'Unknown';
                        const distance = ap.distance || '';
                        detailsHTML += `
                            <div class="ap-item">
                                <div>
                                    <div class="ap-mac">${ap.mac}</div>
                                    <div style="font-size: 10px; color: #7e8ba3;">${ssid} ${distance}</div>
                                </div>
                                <div class="ap-rssi">${ap.rssi} dBm</div>
                            </div>
                        `;
                    });
                } else {
                    // Aucun AP d√©tect√©
                    detailsHTML = '<div style="color: #7e8ba3; text-align: center;">Aucun d√©tail disponible</div>';
                }
                
                // Injecter le HTML dans la section d√©tails
                document.getElementById('details').innerHTML = detailsHTML;
            }
        };
        
        /* ================================================================
           WEBSOCKET : CONNEXION √âTABLIE
           ================================================================
           
           Callback d√©clench√© quand la connexion WebSocket est √©tablie.
        */
        
        ws.onopen = () => {
            /*
             * Actions au d√©marrage:
             * 1. Mettre √† jour l'indicateur de statut (vert)
             * 2. Charger la derni√®re position connue via l'API REST
             */
            
            console.log('‚úì WebSocket connected');
            updateStatus(true);
            
            // Charger la derni√®re position connue (si disponible)
            // Utile si l'utilisateur rafra√Æchit la page
            fetch('http://localhost:8000/api/position')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Simuler la r√©ception d'un message WebSocket
                        ws.onmessage({data: JSON.stringify(data)});
                    }
                })
                .catch(err => console.error('Error fetching initial position:', err));
        };
        
        /* ================================================================
           WEBSOCKET : CONNEXION FERM√âE
           ================================================================
           
           Callback d√©clench√© si la connexion WebSocket est perdue.
        */
        
        ws.onclose = () => {
            /*
             * Actions √† la d√©connexion:
             * - Mettre √† jour l'indicateur de statut (rouge)
             * - Logger dans la console
             */
            
            console.log('‚úó WebSocket disconnected');
            updateStatus(false);
        };
        
        /* ================================================================
           REQU√äTE HTTP : CHARGER LE STATUT INITIAL
           ================================================================
           
           Requ√™te au d√©marrage pour afficher le nombre d'APs en base.
        */
        
        fetch('http://localhost:8000/api/status')
            .then(r => r.json())
            .then(data => {
                /*
                 * R√©ponse attendue:
                 * {
                 *     "status": "running",
                 *     "aps_loaded": 7,
                 *     "fingerprints": 45
                 * }
                 */
                document.getElementById('totalAPs').textContent = data.aps_loaded || 0;
            })
            .catch(err => console.error('Error fetching status:', err));
        
        /* ================================================================
           REQU√äTE HTTP : CHARGER LES APs CONNUS
           ================================================================
           
           Requ√™te au d√©marrage pour afficher les points bleus sur la carte.
           Chaque point bleu = position moyenne d'un AP connu.
        */
        
        fetch('http://localhost:8000/api/aps')
            .then(r => r.json())
            .then(data => {
                /*
                 * R√©ponse attendue:
                 * {
                 *     "total": 7,
                 *     "aps": [
                 *         {
                 *             "mac": "1e:92:9b:e8:5c:d9",
                 *             "ssid": "eduroam",
                 *             "lat": 48.845129,
                 *             "lon": 2.356774,
                 *             "room": "201",
                 *             "floor": "2"
                 *         },
                 *         ...
                 *     ]
                 * }
                 */
                
                // Supprimer les anciens marqueurs (si refresh)
                apMarkers.forEach(m => map.removeLayer(m));
                apMarkers = [];
                
                // Cr√©er un marqueur bleu pour chaque AP
                if (data.aps) {
                    data.aps.forEach(ap => {
                        // CircleMarker = petit cercle au lieu d'un pin
                        const apMarker = L.circleMarker([ap.lat, ap.lon], {
                            radius: 5,
                            fillColor: '#64b5f6',     // Bleu clair
                            color: '#1976d2',         // Bordure bleu fonc√©
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.4
                        }).addTo(map)
                          .bindPopup(`<b>${ap.ssid}</b><br>${ap.mac}<br>Salle ${ap.room}`);
                        
                        // Ajouter √† la liste pour pouvoir les supprimer plus tard
                        apMarkers.push(apMarker);
                    });
                }
            })
            .catch(err => console.error('Error fetching APs:', err));
    </script>
</body>
</html>