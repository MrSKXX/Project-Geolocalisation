<!DOCTYPE html>
<html>
<head>
    <title>Jussieu - G√©olocalisation WiFi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; display: flex; height: 100vh; }
        
        .sidebar { width: 350px; background: #1e293b; padding: 20px; display: flex; flex-direction: column; box-shadow: 2px 0 15px rgba(0,0,0,0.5); z-index: 1000; }
        #map { flex: 1; z-index: 1; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #38bdf8; margin: 0; font-size: 22px; }
        .header p { color: #94a3b8; font-size: 12px; margin: 5px 0 0 0; }
        
        .result-card { background: #334155; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #475569; margin-bottom: 20px; transition: transform 0.2s; }
        .location-name { font-size: 24px; font-weight: bold; color: #fff; margin: 10px 0; }
        .confidence { font-size: 12px; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; display: inline-block; font-weight: bold; }
        .conf-high { background: #16a34a; color: white; }
        .conf-med { background: #ca8a04; color: white; }
        .conf-low { background: #dc2626; color: white; }
        
        .photo-container { width: 100%; height: 200px; background: #0f172a; border-radius: 8px; overflow: hidden; margin-top: 15px; display: flex; align-items: center; justify-content: center; border: 1px solid #475569; }
        .photo-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .placeholder-text { color: #64748b; font-size: 12px; }

        .log-container { flex: 1; background: #0f172a; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; color: #cbd5e1; overflow-y: auto; border: 1px solid #334155; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-time { color: #64748b; margin-right: 5px; }

        /* Icone qui pulse sur la carte */
        .pulse-icon {
            background-color: #38bdf8; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(56, 189, 248, 1);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(56, 189, 248, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h1>üìç Localisation Campus</h1>
            <p>Syst√®me de Fusion WiFi + GPS</p>
        </div>

        <div class="result-card">
            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Position D√©tect√©e</div>
            <div class="location-name" id="locName">--</div>
            <div id="confBadge" class="confidence" style="background: #475569;">Attente...</div>
            
            <div class="photo-container">
                <span class="placeholder-text" id="noPhotoText">Aucune photo disponible</span>
                <img id="roomPhoto" src="" alt="Photo du lieu">
            </div>
        </div>

        <div class="log-container" id="console">
            <div class="log-entry">Syst√®me pr√™t. Attente donn√©es...</div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // 1. Initialisation Carte
        const map = L.map('map').setView([48.8470, 2.3560], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 21 }).addTo(map);

        let userMarker = null;

        function log(msg) {
            const container = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            container.insertBefore(div, container.firstChild);
        }

        // 2. Connexion WebSocket
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

        ws.onopen = () => log("Connect√© au serveur de localisation");
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // On ne s'int√©resse qu'aux mises √† jour de position
            if (data.type === 'position_update' && data.success) {
                updateUI(data);
            }
        };

        function updateUI(data) {
            // A. Mise √† jour Texte
            document.getElementById('locName').innerText = data.location || data.room;
            
            // B. Badge Confiance
            const badge = document.getElementById('confBadge');
            const confVal = parseInt(data.confidence);
            badge.innerText = `Confiance: ${data.confidence}`;
            
            badge.className = 'confidence'; // Reset
            if (confVal > 75) badge.classList.add('conf-high');
            else if (confVal > 40) badge.classList.add('conf-med');
            else badge.classList.add('conf-low');

            // C. Mise √† jour Carte
            if (data.lat && data.lon) {
                if (userMarker) {
                    userMarker.setLatLng([data.lat, data.lon]);
                } else {
                    const icon = L.divIcon({ className: 'pulse-icon', iconSize: [15, 15] });
                    userMarker = L.marker([data.lat, data.lon], { icon: icon }).addTo(map);
                }
                map.panTo([data.lat, data.lon]);
            }

            // D. Mise √† jour Photo
            const imgEl = document.getElementById('roomPhoto');
            const txtEl = document.getElementById('noPhotoText');
            
            if (data.room_photo) {
                imgEl.src = `/photos/${data.room_photo}`;
                imgEl.style.display = 'block';
                txtEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                txtEl.style.display = 'block';
            }

            log(`üìç Localis√©: ${data.location} (${data.confidence})`);
        }

        // Charger les points connus (pour info visuelle)
        fetch('/api/collected-points').then(r => r.json()).then(data => {
            if(data.points) {
                data.points.forEach(p => {
                    L.circleMarker([p.lat, p.lon], {
                        radius: 2, color: '#64748b', fillOpacity: 0.3
                    }).addTo(map);
                });
            }
        });
    </script>
</body>
</html>